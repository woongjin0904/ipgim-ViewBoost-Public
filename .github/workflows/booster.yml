name: Distributed Traffic Tester (Optimized)

# [ìˆ˜ì •] ì‹¤í–‰ ì´ë¦„ì— user_idë¥¼ í¬í•¨ì‹œì¼œ ì„œë²„ APIì—ì„œ ì •ë°€ ì·¨ì†Œê°€ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
run-name: Booster-Task-${{ inputs.user_id }}

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
      site_type:
        description: 'Site Type (NAVER, FEMCO, etc.)'
        required: true
      total_count:
        description: 'Total Target Count'
        default: '20'
      # [ì¶”ê°€] ì‚¬ìš©ì ì‹ë³„ì„ ìœ„í•œ ID
      user_id:
        description: 'Requested User ID'
        required: true

# [í•µì‹¬ ìˆ˜ì •] ê·¸ë£¹ëª…ì„ ì „ì—­ì´ ì•„ë‹Œ ìœ ì €ë³„ IDë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
# ì´ë ‡ê²Œ í•˜ë©´ 'ë‚˜'ì˜ ìƒˆ ì‘ì—…ì´ 'ë‚˜'ì˜ ì˜› ì‘ì—…ë§Œ ì·¨ì†Œí•˜ë©°, ë‹¤ë¥¸ ìœ ì €ì˜ ì‘ì—…ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
concurrency:
  group: viewboost-${{ inputs.user_id }}
  cancel-in-progress: true

jobs:
  boost:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
        run: |
          # ğŸ’¡ ì˜ì¡´ì„± ì„¤ì¹˜ ìµœì í™”
          npm install puppeteer-extra puppeteer-extra-plugin-stealth user-agents
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable libgbm-dev

      - name: Run Worker
        env:
          WORKER_ID: ${{ matrix.worker_id }}
        run: |
          # ì›Œì»¤ ê°„ ê¸°ë™ ì‹œê°„ ë¶„ì‚° (ì•ˆí‹° ë´‡)
          DELAY=$((1 + RANDOM % 60))
          echo "Waiting for $DELAY seconds..."
          sleep $DELAY
          # [ìˆ˜ì •] ì¸ìˆ˜ì— user_id ì¶”ê°€ ì „ë‹¬
          node github_worker.js "${{ github.event.inputs.target_url }}" "${{ github.event.inputs.site_type }}" "${{ github.event.inputs.total_count }}" "${{ github.event.inputs.user_id }}"