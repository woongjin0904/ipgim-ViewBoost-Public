name: Distributed Traffic Tester (Optimized)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
      site_type:
        description: 'NAVER or FEMCO'
        required: true
      total_count:
        description: '전체 목표 조회수'
        default: '20'

concurrency:
  group: viewboost-engine-global
  cancel-in-progress: true

jobs:
  boost:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm' 

      - name: Install Dependencies
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
        run: |
          npm install puppeteer-extra puppeteer-extra-plugin-stealth user-agents
          npm ci || true
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable libgbm-dev

      - name: Run Worker
        env:
          WORKER_ID: ${{ matrix.worker_id }}
        run: |
          DELAY=$((1 + RANDOM % 150))
          echo "Waiting for $DELAY seconds to bypass anti-bot..."
          sleep $DELAY
          node github_worker.js "${{ github.event.inputs.target_url }}" "${{ github.event.inputs.site_type }}" "${{ github.event.inputs.total_count }}"