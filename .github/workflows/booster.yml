name: Distributed Traffic Tester

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
      site_type:
        description: 'NAVER or FEMCO'
        required: true
      total_count:
        description: '전체 목표 조회수 (20대의 컴퓨터가 나누어 가짐)'
        default: '20'
        
concurrency:
  group: ${{ github.event.inputs.target_url }}
  cancel-in-progress: true

jobs:
  boost:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          npm install
          sudo apt-get update
          sudo apt-get install -y libgbm-dev

      - name: Run Worker
        env:
          WORKER_ID: ${{ matrix.worker_id }}
        run: node github_worker.js "${{ github.event.inputs.target_url }}" "${{ github.event.inputs.site_type }}" "${{ github.event.inputs.total_count }}"